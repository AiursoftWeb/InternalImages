stages:
  - deploy

deploy_ubuntu:
  stage: deploy
  script:
    - if [[ "$CI_PROJECT_NAMESPACE" != "aiursoft" ]]; then
        echo "CI pipeline will only run for the Aiursoft namespace.";
        exit 1;
      fi
    - if [ "$CI_COMMIT_REF_NAME" = "master" ]; then TAG="latest"; else TAG="$CI_COMMIT_REF_NAME"; fi
    - echo building image hub.aiursoft.cn/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/ubuntu:$TAG
    - docker build ./Ubuntu -t hub.aiursoft.cn/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/ubuntu:$TAG
    - docker push hub.aiursoft.cn/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/ubuntu:$TAG
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'

deploy_ubuntu_with_docker:
  stage: deploy
  needs: 
    - deploy_ubuntu
  script:
    - if [[ "$CI_PROJECT_NAMESPACE" != "aiursoft" ]]; then
        echo "CI pipeline will only run for the Aiursoft namespace.";
        exit 1;
      fi
    - if [ "$CI_COMMIT_REF_NAME" = "master" ]; then TAG="latest"; else TAG="$CI_COMMIT_REF_NAME"; fi
    - echo building image hub.aiursoft.cn/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/ubuntu-with-docker:$TAG
    - docker build ./Ubuntu-with-docker -t hub.aiursoft.cn/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/ubuntu-with-docker:$TAG
    - docker push hub.aiursoft.cn/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/ubuntu-with-docker:$TAG
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'

deploy_apt_mirror:
  stage: deploy
  needs: 
    - deploy_ubuntu
  script:
    - if [[ "$CI_PROJECT_NAMESPACE" != "aiursoft" ]]; then
        echo "CI pipeline will only run for the Aiursoft namespace.";
        exit 1;
      fi
    - if [ "$CI_COMMIT_REF_NAME" = "master" ]; then TAG="latest"; else TAG="$CI_COMMIT_REF_NAME"; fi
    - echo building image hub.aiursoft.cn/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/apt-mirror:$TAG
    - docker build ./AptMirror -t hub.aiursoft.cn/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/apt-mirror:$TAG
    - docker push hub.aiursoft.cn/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/apt-mirror:$TAG
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'

deploy_lab:
  stage: deploy
  needs: 
    - deploy_ubuntu
  script:
    - if [[ "$CI_PROJECT_NAMESPACE" != "aiursoft" ]]; then
        echo "CI pipeline will only run for the Aiursoft namespace.";
        exit 1;
      fi
    - if [ "$CI_COMMIT_REF_NAME" = "master" ]; then TAG="latest"; else TAG="$CI_COMMIT_REF_NAME"; fi
    - echo building image hub.aiursoft.cn/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/lab:$TAG
    - docker build ./Lab -t hub.aiursoft.cn/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/lab:$TAG
    - docker push hub.aiursoft.cn/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/lab:$TAG
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'

deploy_runner:
  stage: deploy
  needs: 
    - deploy_ubuntu_with_docker
  script:
    - if [[ "$CI_PROJECT_NAMESPACE" != "aiursoft" ]]; then
        echo "CI pipeline will only run for the Aiursoft namespace.";
        exit 1;
      fi
    - if [ "$CI_COMMIT_REF_NAME" = "master" ]; then TAG="latest"; else TAG="$CI_COMMIT_REF_NAME"; fi
    - echo building image hub.aiursoft.cn/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/runner:$TAG
    - docker build ./Runner -t hub.aiursoft.cn/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/runner:$TAG
    - docker push hub.aiursoft.cn/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/runner:$TAG
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'

# Continue for remaining jobs with the same pattern
deploy_kiwix:
  stage: deploy
  needs: 
    - deploy_ubuntu
  script:
    - if [[ "$CI_PROJECT_NAMESPACE" != "aiursoft" ]]; then
        echo "CI pipeline will only run for the Aiursoft namespace.";
        exit 1;
      fi
    - if [ "$CI_COMMIT_REF_NAME" = "master" ]; then TAG="latest"; else TAG="$CI_COMMIT_REF_NAME"; fi
    - echo building image hub.aiursoft.cn/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/kiwix:$TAG
    - docker build ./Kiwix -t hub.aiursoft.cn/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/kiwix:$TAG
    - docker push hub.aiursoft.cn/$CI_PROJECT_NAMESPACE/$CI_PROJECT_NAME/kiwix:$TAG
  rules:
    - if: '$CI_COMMIT_BRANCH == "master"'

# Add remaining jobs with the same pattern...